<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Icofr Testing Views -->
    <record id="view_icofr_testing_list" model="ir.ui.view">
        <field name="name">icofr.testing.list</field>
        <field name="model">icofr.testing</field>
        <field name="arch" type="xml">
            <list string="Pengujian Kontrol">
                <field name="name"/>
                <field name="control_id"/>
                <field name="test_date"/>
                <field name="tester_id"/>
                <field name="status"/>
            </list>
        </field>
    </record>

    <record id="view_icofr_testing_form" model="ir.ui.view">
        <field name="name">icofr.testing.form</field>
        <field name="model">icofr.testing</field>
        <field name="arch" type="xml">
            <form string="Pengujian Kontrol">
                <header>
                    <field name="status" widget="statusbar"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                    </div>
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    <group>
                        <group>
                            <field name="control_id"/>
                            <field name="test_type"/>
                            <field name="tester_id"/>
                            <field name="testing_method"/>
                        </group>
                        <group>
                            <field name="test_date"/>
                            <field name="effectiveness"/>
                            <field name="status"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Validasi Rancangan (Test of One)" invisible="test_type != 'design_validation'">
                            <group>
                                <field name="design_validation_conclusion" widget="radio" options="{'horizontal': true}"/>
                                <field name="sample_size_calculated" readonly="1" string="Jumlah Sampel (Wajib 1)"/>
                            </group>
                        </page>
                        <page string="Test of Design (TOD)" invisible="test_type != 'tod'">
                            <group string="Kertas Kerja Verifikasi Rancangan (Lampiran 8 Juknis)">
                                <group>
                                    <field name="tod_objective_attainment"/>
                                    <field name="tod_timing_accuracy"/>
                                    <field name="tod_authority_competence"/>
                                </group>
                                <group>
                                    <field name="tod_info_reliability"/>
                                    <field name="tod_period_coverage"/>
                                    <field name="tod_evidence_sufficiency"/>
                                </group>
                            </group>
                            <group>
                                <field name="design_description" placeholder="Evaluasi rancangan pengendalian..."/>
                                <field name="design_conclusion" widget="radio" options="{'horizontal': true}"/>
                            </group>
                        </page>
                        <page string="Test of Operating Effectiveness (TOE)" invisible="test_type != 'toe'">
                            <group string="Deskripsi Atribut Pengujian (Lampiran 7 Juknis)">
                                <group>
                                    <field name="attr_a_desc" placeholder="Atribut A (misal: Transaksi terotorisasi)"/>
                                    <field name="attr_b_desc" placeholder="Atribut B (misal: Nilai sesuai invoice)"/>
                                </group>
                                <group>
                                    <field name="attr_c_desc" placeholder="Atribut C (misal: Periode pencatatan benar)"/>
                                    <field name="attr_d_desc" placeholder="Atribut D (misal: Klasifikasi akun tepat)"/>
                                </group>
                            </group>
                            <group>
                                <group string="Sampling &amp; Populasi">
                                    <field name="population_reference"/>
                                    <field name="sample_selection_method"/>
                                    <field name="sample_size"/>
                                </group>
                                <group string="Hasil Eksekusi">
                                    <field name="testing_steps"/>
                                    <field name="exceptions_noted"/>
                                </group>
                            </group>
                            <div class="mb-2">
                                <button name="%(icofr.action_icofr_sample_selection_wizard)d" 
                                        type="action" string="Pilih Sampel dari Populasi" 
                                        class="btn-secondary mr-2" icon="fa-plus-circle"
                                        context="{'default_testing_id': id}"/>
                                <button name="%(icofr.action_icofr_population_pull_erp_wizard)d" 
                                        type="action" string="Tarik Data dari ERP" 
                                        class="btn-primary" icon="fa-database"
                                        context="{'default_testing_id': id, 'default_control_id': control_id}"/>
                            </div>
                        </page>
                        <page string="Sampel Terpilih (Testing Log)" invisible="test_type != 'toe'">
                            <field name="sample_ids">
                                <list editable="bottom">
                                    <field name="transaction_no" readonly="1"/>
                                    <field name="transaction_date" readonly="1"/>
                                    <field name="amount" readonly="1"/>
                                    <field name="result_attr_a" string="Attr A" widget="radio" options="{'horizontal': true}"/>
                                    <field name="result_attr_b" string="Attr B" widget="radio" options="{'horizontal': true}"/>
                                    <field name="result_attr_c" string="Attr C" widget="radio" options="{'horizontal': true}"/>
                                    <field name="result_attr_d" string="Attr D" widget="radio" options="{'horizontal': true}"/>
                                    <field name="testing_result" string="Hasil"/>
                                    <field name="testing_notes"/>
                                </list>
                            </field>
                        </page>
                        <page string="Verifikasi Teknis (IPE/MRC)" invisible="control_id.control_specific_type not in ('ipe', 'mrc')">
                            <div class="alert alert-info" role="alert" invisible="control_id.control_specific_type != 'ipe'">
                                <strong>Panduan IPE (Tabel 20):</strong> Lakukan pengujian untuk memastikan parameter ekstraksi benar dan data lengkap.
                            </div>
                            <div class="alert alert-info" role="alert" invisible="control_id.control_specific_type != 'mrc'">
                                <strong>Panduan MRC (Tabel 21):</strong> Pastikan adanya bukti professional skepticism dan investigasi atas deviasi di luar threshold.
                            </div>
                            <group invisible="control_id.control_specific_type != 'ipe'">
                                <group string="Atribut IPE">
                                    <field name="ipe_parameter_verified" widget="radio" options="{'horizontal': true}"/>
                                    <field name="ipe_extraction_valid" widget="radio" options="{'horizontal': true}"/>
                                    <field name="ipe_itgc_effective" widget="radio" options="{'horizontal': true}"/>
                                </group>
                            </group>
                            <group invisible="control_id.control_specific_type != 'mrc'">
                                <group string="Atribut MRC">
                                    <field name="mrc_skepticism_applied" widget="radio" options="{'horizontal': true}"/>
                                    <field name="mrc_threshold_appropriate" widget="radio" options="{'horizontal': true}"/>
                                </group>
                                <group string="Eksekusi MRC">
                                    <field name="mrc_reperformance_done" widget="radio" options="{'horizontal': true}"/>
                                    <field name="mrc_investigation_proven" widget="radio" options="{'horizontal': true}"/>
                                </group>
                            </group>
                        </page>
                        <page string="Detail Prosedur &amp; Hasil">
                            <field name="testing_procedures"/>
                            <field name="test_results"/>
                        </page>
                        <page string="Kalkulator Sampling (Tabel 22 &amp; 23 Juknis)" invisible="test_type != 'toe'">
                            <group>
                                <group string="Parameter">
                                    <field name="is_remediation_test"/>
                                    <field name="control_frequency"/>
                                    <field name="population_size"/>
                                </group>
                                <group string="Hasil Kalkulator">
                                    <field name="sample_size_recommended" readonly="1" class="oe_inline"/>
                                    <field name="remediation_min_period" invisible="not is_remediation_test" class="oe_inline"/>
                                    <field name="sample_size_calculated" string="Target Sampel Minimal" class="oe_highlight"/>
                                    <p class="text-muted" colspan="2">
                                        * Berdasarkan Tabel 22 (TOE standar) atau Tabel 23 (Remediasi) Juknis BUMN.
                                    </p>
                                </group>
                            </group>
                        </page>
                        <page string="Temuan &amp; Rekomendasi">
                            <group>
                                <field name="findings"/>
                                <field name="recommendation"/>
                            </group>
                        </page>
                        <page string="Lampiran Bukti">
                            <field name="evidence_attachment_ids" widget="many2many_binary"/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="view_icofr_testing_search" model="ir.ui.view">
        <field name="name">icofr.testing.search</field>
        <field name="model">icofr.testing</field>
        <field name="arch" type="xml">
            <search string="Pengujian Kontrol">
                <field name="name"/>
            </search>
        </field>
    </record>

    <!-- Action untuk Icofr Testing -->
    <record id="action_icofr_testing" model="ir.actions.act_window">
        <field name="name">Pengujian Kontrol</field>
        <field name="res_model">icofr.testing</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Tambahkan pengujian kontrol pertama anda!
            </p><p>
                Pengujian kontrol digunakan untuk mengevaluasi efektivitas
                kontrol internal terhadap risiko finansial.
            </p>
        </field>
    </record>

    <!-- Menu item untuk Pengujian Kontrol -->
    <menuitem id="menu_icofr_testing"
              name="Pengujian Kontrol"
              sequence="51"
              parent="menu_icofr_operational"
              action="action_icofr_testing"/>
</odoo>